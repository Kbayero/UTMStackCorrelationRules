# https://docs.paloaltonetworks.com/cortex/cortex-xdr/cortex-xdr-pro-admin/logs/cortex-xdr-log-notification-formats (june, 2022)
# Rule version v1.0.0

- name: "Potentially Unwanted Application detected by Palo Alto Cortex XDR"
  severity: "Medium"
  description: "Grayware or Potentially Unwanted Application (PUA) is a broad category of software, 
                whose intent is not as unequivocally malicious as with other types of malware, such as viruses or trojan horses. 
                It may however install additional unwanted software, change the behavior of the digital device, or perform activities not approved or expected by the user.
                Categories that may be considered grayware include: advertising display software, download wrappers, various browser toolbars, 
                software with misleading behavior, bundleware, trackware, crypto-miners, registry cleaners (Windows operating systems only) or any other borderline software, 
                or software that uses illicit or at least unethical business practices (despite appearing legitimate) 
                and might be deemed undesirable by an end user who became aware of what the software would do if allowed to install.
                A Potentially Unsafe Application is in itself legitimate (possibly commercial) software but which might be misused by an attacker."
  solution: "Install anti-virus/malware software to keep your PC virus free. Keep your antivirus 
             software up to date. Run regularly scheduled scans with your antivirus software. 
             Keep your operating system up to date. Protect your red."
  category: "Impact"
  tactic: "Data Manipulation"
  reference:
    - "https://attack.mitre.org/tactics/TA0040/"
    - "https://attack.mitre.org/techniques/T1565/"
  frequency: 60
  cache: 
    - oneOf:
        - field: "logx.paloalto_cortex_xdr.verdict"
          operator: "in"
          value: "2,Grayware"
        - field: "logx.paloalto_cortex_xdr.moduleStatusId"
          operator: "=="
          value: "CYSTATUS_WILDFIRE_GRAYWARE"
        - field: "logx.paloalto_cortex_xdr.act_msg"
          operator: "regexp"
          value: "([Gg]rayware|PUA|[Pp]otentially [Uu]nwanted [Aa]pplication)"
        - field: "logx.paloalto_cortex_xdr.cat"
          operator: "regexp"
          value: "([Gg]rayware|PUA|[Pp]otentially [Uu]nwanted [Aa]pplication)"
        - field: "logx.paloalto_cortex_xdr.msg"
          operator: "regexp"
          value: "([Gg]rayware|PUA|[Pp]otentially [Uu]nwanted [Aa]pplication)"
        - field: "logx.paloalto_cortex_xdr.profile"
          operator: "regexp"
          value: "([Gg]rayware|PUA|[Pp]otentially [Uu]nwanted [Aa]pplication)"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.paloalto_cortex_xdr.suser"
          alias: "SourceUser"
        - field: "logx.paloalto_cortex_xdr.src_ip"
          alias: "SourceIP"
        - field: "logx.paloalto_cortex_xdr.src_port"
          alias: "SourcePort"
        - field: "logx.paloalto_cortex_xdr.dest_ip"
          alias: "DestinationIP"
        - field: "logx.paloalto_cortex_xdr.dest_port"
          alias: "DestinationPort"