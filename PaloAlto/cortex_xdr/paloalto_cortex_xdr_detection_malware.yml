# https://docs.paloaltonetworks.com/cortex/cortex-xdr/cortex-xdr-pro-admin/logs/cortex-xdr-log-notification-formats (june, 2022)
# Rule version v1.0.0

- name: "Probable malware infection detected by Palo Alto Cortex XDR"
  severity: "High"
  description: "Malware is a computer program whose main characteristic is that it runs 
                without the knowledge or authorization of the owner or user of the infected 
                computer and performs functions on the system that are harmful to the user and/or 
                the system. Identifies malware infections"
  solution: "Install anti-virus/malware software to keep your PC virus free. Keep your antivirus 
             software up to date. Run regularly scheduled scans with your antivirus software. 
             Keep your operating system up to date. Protect your red."
  category: "Execution"
  tactic: "User Execution"
  reference:
    - "https://attack.mitre.org/tactics/TA0002/"
    - "https://attack.mitre.org/techniques/T1204/002/"
  frequency: 60
  cache: 
    - oneOf:
        - field: "logx.paloalto_cortex_xdr.verdict"
          operator: "in"
          value: "1,Malware"
        - field: "logx.paloalto_cortex_xdr.moduleStatusId"
          operator: "in"
          value: "CYSTATUS_CHILD_PROCESS_BLOCKED,CYSTATUS_CPLPROT_BLACKLIST,CYSTATUS_WILDFIRE_MALWARE,CYSTATUS_MALICIOUS_STRING_DETECTED,CYSTATUS_MALICIOUS_MACRO,CYSTATUS_MALICIOUS_EXE_ASYNC,CYSTATUS_MALICIOUS_EXE,CYSTATUS_MALICIOUS_DLL,CYSTATUS_MALICIOUS_APK,CYSTATUS_MACOS_MALICIOUS_DYLIB,CYSTATUS_DLLPROT_BLACKLIST,CYSTATUS_HASH_CONTROL,CYSTATUS_UNSIGNED_CHILD_PROCESS_BLOCKED"
        - field: "logx.paloalto_cortex_xdr.act_msg"
          operator: "regexp"
          value: "([Mm]alware)"
        - field: "logx.paloalto_cortex_xdr.cat"
          operator: "regexp"
          value: "([Mm]alware)"
        - field: "logx.paloalto_cortex_xdr.msg"
          operator: "regexp"
          value: "([Mm]alware)"
        - field: "logx.paloalto_cortex_xdr.profile"
          operator: "regexp"
          value: "([Mm]alware)"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.paloalto_cortex_xdr.suser"
          alias: "SourceUser"
        - field: "logx.paloalto_cortex_xdr.src_ip"
          alias: "SourceIP"
        - field: "logx.paloalto_cortex_xdr.src_port"
          alias: "SourcePort"
        - field: "logx.paloalto_cortex_xdr.dest_ip"
          alias: "DestinationIP"
        - field: "logx.paloalto_cortex_xdr.dest_port"
          alias: "DestinationPort"