# https://docs.paloaltonetworks.com/cortex/cortex-xdr/cortex-xdr-pro-admin/logs/cortex-xdr-log-notification-formats (june, 2022)
# Rule version v1.0.0

- name: "Probable attempt to exploit vulnerabilities detected by Palo Alto Cortex XDR"
  severity: "High"
  description: "An exploit is a small program designed to exploit a particular bug in an operating system or program for various purposes. 
                Depending on the type of vulnerability, the exploit can have different purposes, 
                such as gaining administrator permissions on the system or bypassing security measures in order to carry out a deeper infection."
  solution: "Download only from trusted sources. Use security tools. Keep systems and applications up to date. Keep an eye on the plugins we install"
  category: "Credential Access"
  tactic: "Exploitation for Credential Access"
  reference:
    - "https://attack.mitre.org/tactics/TA0006/"
    - "https://attack.mitre.org/techniques/T1212/"
  frequency: 60
  cache: 
    - oneOf:
        - field: "logx.paloalto_cortex_xdr.moduleStatusId"
          operator: "in"
          value: "CYSTATUS_ALIGNED_HEAP_SPRAY_DETECTED,CYSTATUS_ROP_MITIGATION,CYSTATUS_NOP_SLED_DETECTED,CYSTATUS_LINUX_SHELLCODE_PREVENTED,CYSTATUS_LINUX_SOCKET_SHELL_PREVENTED"
        - field: "logx.paloalto_cortex_xdr.act_msg"
          operator: "regexp"
          value: "([Ee]xploit)"
        - field: "logx.paloalto_cortex_xdr.cat"
          operator: "regexp"
          value: "([Ee]xploit)"
        - field: "logx.paloalto_cortex_xdr.msg"
          operator: "regexp"
          value: "([Ee]xploit)"
        - field: "logx.paloalto_cortex_xdr.profile"
          operator: "regexp"
          value: "([Ee]xploit)"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.paloalto_cortex_xdr.suser"
          alias: "SourceUser"
        - field: "logx.paloalto_cortex_xdr.src_ip"
          alias: "SourceIP"
        - field: "logx.paloalto_cortex_xdr.src_port"
          alias: "SourcePort"
        - field: "logx.paloalto_cortex_xdr.dest_ip"
          alias: "DestinationIP"
        - field: "logx.paloalto_cortex_xdr.dest_port"
          alias: "DestinationPort"